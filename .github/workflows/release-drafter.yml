# name: Release Drafter

# on:
#   push:
#     # branches to consider in the event; optional, defaults to all
#     branches:
#       - master
#   # pull_request event is required only for autolabeler
#   pull_request:
#     # Only following types are handled by the action, but one can default to all as well
#     types: [opened, reopened, synchronize]
#   # pull_request_target event is required for autolabeler to support PRs from forks
#   # pull_request_target:
#   #   types: [opened, reopened, synchronize]

# permissions:
#   contents: read

# jobs:
#   update_release_draft:
#     permissions:
#       # write permission is required to create a github release
#       contents: write
#       # write permission is required for autolabeler
#       # otherwise, read permission is required at least
#       pull-requests: write
#     runs-on: ubuntu-latest
#     steps:
#       # (Optional) GitHub Enterprise requires GHE_HOST variable set
#       #- name: Set GHE_HOST
#       #  run: |
#       #    echo "GHE_HOST=${GITHUB_SERVER_URL##https:\/\/}" >> $GITHUB_ENV
#       # Drafts your next Release notes as Pull Requests are merged into "master"
#       - name: Check branch name
#         run: |
#           branch_name=${{ toJson(github.event.pull_request.head.ref) }}
#           echo "${{ toJson(github.event.pull_request) }} fasdfafasfasdfasdfasfasf1 $branch_name"
#           if [[ $branch_name =~ (major|minor|patch)[\/:\s].+ ]]; then
#             echo "Branch name contains 'major', 'minor', or 'patch' followed by a delimiter and some text. Proceeding with release draft update."
#           else
#             echo "Branch name does not match the required pattern. Skipping release draft update."
#             exit 1
#           fi
#       # Drafts your next Release notes as Pull Requests are merged into "master"
#       - uses: release-drafter/release-drafter@v5
#         # (Optional) specify config name to use, relative to .github/. Default: release-drafter.yml
#         # with:
#         #   config-name: my-config.yml
#         #   disable-autolabeler: true
#         env:
#           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: Release Drafter Test

on:
  pull_request:
    types: [opened, reopened, synchronize]
    branches:
      - master

permissions:
  contents: read

jobs:
  update_release_draft:
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - name: Check branch name and cache it
        id: cache_branch_name
        run: |
          # Check if the branch name is already cached
          if [ -f "$HOME/CACHED_BRANCH_NAME.txt" ]; then
            # If cached, read the branch name from the cache file
            CACHED_BRANCH_NAME=$(cat "$HOME/CACHED_BRANCH_NAME.txt")
            echo "::set-output name=cached_branch_name::$CACHED_BRANCH_NAME"
          else
            # If not cached, extract the branch name from the pull request event and cache it
            BRANCH_NAME=${{ github.event.pull_request.head.ref }}
            echo "$BRANCH_NAME" > "$HOME/CACHED_BRANCH_NAME.txt"
            echo "::set-output name=cached_branch_name::$BRANCH_NAME"
          fi

      - name: Draft release notes
        run: |
          # Retrieve the cached branch name
          CACHED_BRANCH_NAME="${{ steps.cache_branch_name.outputs.cached_branch_name }}"
          echo "Cached branch name: $CACHED_BRANCH_NAME"

          # Use the cached branch name as needed
          if [[ $CACHED_BRANCH_NAME =~ (major|minor|patch)[\/:\s].+ ]]; then
            echo "Branch name contains 'major', 'minor', or 'patch' followed by a delimiter and some text. Proceeding with release draft update."
          else
            echo "Branch name does not match the required pattern. Skipping release draft update."
            exit 1
          fi

      - uses: release-drafter/release-drafter@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
